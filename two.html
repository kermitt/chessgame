<html>

<head>
    <script>
    // GLOBALS  
      let id_rc = {}
      let rc_id = {}
      const letters = ["a", "b", "c", "d", "e", "f", "g", "h"]
    </script>

    <link rel="stylesheet" type="text/css" href="js/logic/style.css">
    <script src='js/logic/Cell.js'></script>
    <script src='js/logic/Pieces.js'></script>
</head>

<body>
    <table border='1'>
        <tr>
            <td>
                <div id="board"></div>
            </td>
            <td>
                <div id="board2"></div>
            </td>
        </tr>
    </table>
    <script>
        let board = {} 
        const zeroout = () => {
            for (let domId1 in id_rc) {
              let domId2 = domId1 + "_2"
                document.getElementById(domId1).classList.remove("influenced")
                document.getElementById(domId2).classList.remove("influenced")
                document.getElementById(domId1).classList.remove("attack")
                document.getElementById(domId2).classList.remove("attack")
                document.getElementById(domId1).classList.remove("support")
                document.getElementById(domId2).classList.remove("support")
            }
        }
        const pawnClick = (key) => {
            zeroout()
            let pawn = pieces[key]

            let rc = id_rc[pawn.cellId]
            let row = rc[0]
            let col = rc[1]
            pawn.moves.forEach((ary, j) => {
                let r = row
                let c = col
                let possibleSpaces = pawn.moveCount === 0 ? 2 : 1
                for (let i = 0; i < possibleSpaces; i++) {
                    r += ary[0]
                    c += ary[1]
                    let candidateKey = r + "_" + c
                    if (rc_id.hasOwnProperty(candidateKey)) {
                        let domId1 = rc_id[candidateKey]
                        let domId2 = domId1 + "_2"

                        document.getElementById(domId1).classList.add("influenced")
                        document.getElementById(domId2).classList.add("influenced")
                    }
                }
            })
        }
        const kingClick = (key) => {
            zeroout()
            let pawn = pieces[key]

            let rc = id_rc[pawn.cellId]
            let row = rc[0]
            let col = rc[1]
            pawn.moves.forEach((ary, j) => {
                let r = row + ary[0]
                let c = col + ary[1]
                let candidateKey = r + "_" + c
                if (rc_id.hasOwnProperty(candidateKey)) {
                  let domId1 = rc_id[candidateKey]
                  let domId2 = domId1 + "_2"

                  document.getElementById(domId1).classList.add("influenced")
                  document.getElementById(domId2).classList.add("influenced")
                }
            })
        }

        const pieceClick = (key) => {

            zeroout()
            let p = pieces[key]

            let rc = id_rc[p.cellId]
            let row = rc[0]
            let col = rc[1]
            p.moves.forEach((ary, j) => {
                let r = row
                let c = col
                for (let i = 0; i < p.possibleSpaces; i++) {

                    r += ary[0]
                    c += ary[1]

                    let candidateKey = r + "_" + c
                    if (rc_id.hasOwnProperty(candidateKey)) {
                        let domId1 = rc_id[candidateKey]
                        let domId2 = domId1 + "_2"

                        let otherPieceId = board[domId1].getPieceId()

                        if ( pieces.hasOwnProperty(otherPieceId )) {

                            let otherColor = pieces[otherPieceId].color

                            if ( otherColor === p.color ) {
                              document.getElementById(domId1).classList.add("support")
                              document.getElementById(domId2).classList.add("support")
                            } else {
                              document.getElementById(domId1).classList.add("attack")
                              document.getElementById(domId2).classList.add("attack")
                            }
                        } else {
                          document.getElementById(domId1).classList.add("influenced")
                          document.getElementById(domId2).classList.add("influenced")
                        }
                    }
                }
            })
        }

        const cellClick = (id) => {
            //console.log(id)
        }
       

        function makeLogicBoard() {
            let k = 0
            for (let row = 8; row > 0; row--) {
                for (let col = 1; col < 9; col++) {
                    let rc = row + "_" + col
                    let id = letters[col - 1] + row
                    id_rc[id] = [row, col]
                    rc_id[rc] = id
                    k++
                    let css = k % 2 == 0 ? 'dark' : 'light'
                    let cell = new Cell( css, id)
                    board[id]=cell
                }
                k++
            }
            makeTables()
        }

        const makeTables = () => {
            // Make the LEFT board ( white's POV  )
            let html1 = "<table border='1'>"

            for (let row = 8; row > 0; row--) {
                html1 += "<tr>"
                for (let col = 1; col < 9; col++) {
                    let id = letters[col - 1] + row
                    html1 += board[id].getCellHtml()
                }
                html1 += "</tr>"
            }
            html1 += "</table>"
            document.getElementById("board").innerHTML = html1

            // Make the mirrored RIGHT board ( black's POV  )
            let html2 = "<table border='1'>"
            for (let row = 1; row < 9; row++) {
                html2 += "<tr>"
                for (let col = 8; col > 0; col--) {
                  let actualCellId = letters[col - 1] + row
                    let id2 = letters[col - 1] + row + "_2"
                    html2 += board[actualCellId].getCellHtml2()
                }
                html2 += "</tr>"
            }
            html2 += "</table>"
            document.getElementById("board2").innerHTML = html2
        }

        function addPieces() {
          for ( let pieceId in pieces) {
            let piece = pieces[pieceId]
            let cellId = piece.cellId
            
            board[cellId].setPiece(pieceId) // for logic 
            let cellId1_dom = cellId // for display
            let cellId2_dom = cellId + "_2" // for display
            
            document.getElementById(cellId1_dom).innerHTML = piece.getHtml()
            document.getElementById(cellId2_dom).innerHTML = piece.getHtml()
          }
        }
        makeLogicBoard();
        addPieces()
    </script>
</body>

</html>